name: Test Suite

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  # Default Redis connection for all jobs
  REDIS_HOST: 127.0.0.1
  REDIS_PORT: 6379

jobs:
  unit-tests:
    name: Unit Tests - PHP ${{ matrix.php-version }} (${{ matrix.deps }})
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        php-version: ['8.1', '8.2', '8.3', '8.4']
        deps: [stable, lowest]
        include:
          - php-version: '8.4'
            deps: 'stable'
            coverage: true

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ matrix.php-version }}
        extensions: redis, json, mbstring, tokenizer, intl, bcmath
        coverage: ${{ matrix.coverage && 'xdebug' || 'none' }}

    - name: Get composer cache directory
      id: composer-cache
      run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

    - name: Cache composer dependencies
      uses: actions/cache@v3
      with:
        path: ${{ steps.composer-cache.outputs.dir }}
        key: ${{ runner.os }}-composer-test-${{ matrix.php-version }}-${{ matrix.deps }}-${{ hashFiles('**/composer.json') }}
        restore-keys: |
          ${{ runner.os }}-composer-test-${{ matrix.php-version }}-${{ matrix.deps }}-
          ${{ runner.os }}-composer-test-${{ matrix.php-version }}-

    - name: Install dependencies
      run: |
        if [ "${{ matrix.deps }}" = "lowest" ]; then
          composer update --prefer-lowest --prefer-dist --no-interaction
        else
          composer install --prefer-dist --no-interaction
        fi

    - name: Run PHPUnit tests
      run: |
        if [ "${{ matrix.coverage }}" = "true" ]; then
          vendor/bin/phpunit --coverage-clover=coverage.xml --coverage-text --log-junit=test-results.xml
        else
          vendor/bin/phpunit --log-junit=test-results.xml
        fi

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: test-results-php${{ matrix.php-version }}-${{ matrix.deps }}
        path: test-results.xml
        retention-days: 30

    - name: Upload coverage to Codecov
      if: matrix.coverage == 'true'
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unit-tests
        name: codecov-unit-tests

  integration-tests:
    name: Integration Tests - PHP ${{ matrix.php-version }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        php-version: ['8.2', '8.3', '8.4']

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ matrix.php-version }}
        extensions: redis, json, mbstring, tokenizer, intl, bcmath, pcntl

    - name: Get composer cache directory
      id: composer-cache
      run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

    - name: Cache composer dependencies
      uses: actions/cache@v3
      with:
        path: ${{ steps.composer-cache.outputs.dir }}
        key: ${{ runner.os }}-composer-integration-${{ matrix.php-version }}-${{ hashFiles('**/composer.json') }}

    - name: Install dependencies
      run: composer install --prefer-dist --no-interaction

    - name: Install Hyperf testing dependencies
      run: |
        if ! composer show hyperf/testing >/dev/null 2>&1; then
          composer require --dev hyperf/testing --no-update
          composer update hyperf/testing --no-interaction
        fi

    - name: Run integration tests
      run: |
        if [ -d "tests/Integration" ]; then
          vendor/bin/phpunit tests/Integration --log-junit=integration-test-results.xml
        else
          echo "â„¹ï¸ No integration tests directory found, skipping integration tests"
        fi

    - name: Run feature tests
      run: |
        if [ -d "tests/Feature" ]; then
          vendor/bin/phpunit tests/Feature --log-junit=feature-test-results.xml
        else
          echo "â„¹ï¸ No feature tests directory found, skipping feature tests"
        fi

    - name: Upload integration test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: integration-test-results-php${{ matrix.php-version }}
        path: |
          integration-test-results.xml
          feature-test-results.xml
        retention-days: 30

  performance-tests:
    name: Performance Tests - PHP ${{ matrix.php-version }}
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    strategy:
      matrix:
        php-version: ['8.2', '8.3', '8.4']

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ matrix.php-version }}
        extensions: redis, json, mbstring, tokenizer, intl, bcmath, pcntl
        ini-values: memory_limit=512M

    - name: Install dependencies
      run: composer install --prefer-dist --no-interaction

    - name: Run performance benchmarks
      run: |
        echo "ðŸš€ Running performance benchmarks..."

        # Basic benchmark
        if [ -f "benchmark.php" ]; then
          php benchmark.php
        else
          echo "â„¹ï¸ No benchmark.php found, creating basic performance test..."

          # Create simple performance test
          cat > performance-test.php << 'EOF'
          <?php
          require_once 'vendor/autoload.php';

          $start = microtime(true);

          // Test MCP server initialization
          try {
              // Simulate server startup performance
              $memory_start = memory_get_usage(true);

              // Simulate some basic operations
              $iterations = 1000;
              for ($i = 0; $i < $iterations; $i++) {
                  // Simulate tool registration
                  $tools = [];
                  for ($j = 0; $j < 10; $j++) {
                      $tools["tool_$j"] = [
                          'name' => "test_tool_$j",
                          'description' => "Test tool $j"
                      ];
                  }
              }

              $end = microtime(true);
              $memory_end = memory_get_usage(true);

              echo "Performance Test Results:\n";
              echo "Time: " . round(($end - $start) * 1000, 2) . " ms\n";
              echo "Memory: " . round(($memory_end - $memory_start) / 1024 / 1024, 2) . " MB\n";
              echo "Iterations: $iterations\n";

              // Performance thresholds
              $time_limit = 1000; // 1 second
              $memory_limit = 50; // 50MB

              if (($end - $start) * 1000 > $time_limit) {
                  echo "âš ï¸ Performance warning: Time limit exceeded\n";
                  exit(1);
              }

              if (($memory_end - $memory_start) / 1024 / 1024 > $memory_limit) {
                  echo "âš ï¸ Performance warning: Memory limit exceeded\n";
                  exit(1);
              }

              echo "âœ… Performance test passed\n";
          } catch (Exception $e) {
              echo "âŒ Performance test failed: " . $e->getMessage() . "\n";
              exit(1);
          }
          EOF

          php performance-test.php
        fi

  redis-compatibility:
    name: Redis Compatibility Tests
    runs-on: ubuntu-latest

    strategy:
      matrix:
        redis-version: ['6', '7']
        php-version: ['8.1', '8.3']

    services:
      redis:
        image: redis:${{ matrix.redis-version }}-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ matrix.php-version }}
        extensions: redis, json, mbstring, tokenizer

    - name: Install dependencies
      run: composer install --prefer-dist --no-interaction

    - name: Test Redis connectivity
      run: |
        echo "ðŸ” Testing Redis connectivity (Redis ${{ matrix.redis-version }})..."
        php -r "
        \$redis = new Redis();
        \$connected = \$redis->connect('127.0.0.1', 6379);
        if (\$connected) {
            echo 'âœ… Redis connection successful\n';
            \$redis->set('test_key', 'test_value');
            \$value = \$redis->get('test_key');
            if (\$value === 'test_value') {
                echo 'âœ… Redis read/write test successful\n';
            } else {
                echo 'âŒ Redis read/write test failed\n';
                exit(1);
            }
            \$redis->close();
        } else {
            echo 'âŒ Redis connection failed\n';
            exit(1);
        }
        "

    - name: Run Redis-specific tests
      run: |
        if [ -d "tests/Redis" ]; then
          vendor/bin/phpunit tests/Redis --log-junit=redis-test-results.xml
        else
          echo "â„¹ï¸ No Redis-specific tests found"

          # Create basic Redis test
          cat > redis-test.php << 'EOF'
          <?php
          require_once 'vendor/autoload.php';

          echo "Testing Redis session management...\n";

          try {
              $redis = new Redis();
              $redis->connect('127.0.0.1', 6379);

              // Test session storage simulation
              $sessionId = 'test_session_' . uniqid();
              $sessionData = [
                  'user_id' => 123,
                  'created_at' => time(),
                  'mcp_server' => 'test_server'
              ];

              $redis->setex($sessionId, 3600, json_encode($sessionData));

              $retrieved = json_decode($redis->get($sessionId), true);

              if ($retrieved['user_id'] === 123) {
                  echo "âœ… Redis session test passed\n";
              } else {
                  echo "âŒ Redis session test failed\n";
                  exit(1);
              }

              $redis->del($sessionId);
              $redis->close();
          } catch (Exception $e) {
              echo "âŒ Redis test failed: " . $e->getMessage() . "\n";
              exit(1);
          }
          EOF

          php redis-test.php
        fi

    - name: Upload Redis test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: redis-test-results-${{ matrix.redis-version }}-php${{ matrix.php-version }}
        path: redis-test-results.xml
        retention-days: 30

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    if: always() && github.event_name == 'pull_request'
    needs: [unit-tests, integration-tests, redis-compatibility]

    steps:
    - name: Create test summary
      run: |
        echo "# Test Suite Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ needs.unit-tests.result }}" == "success" ]; then
          echo "âœ… Unit Tests: Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ Unit Tests: Failed" >> $GITHUB_STEP_SUMMARY
        fi

        if [ "${{ needs.integration-tests.result }}" == "success" ]; then
          echo "âœ… Integration Tests: Passed" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.integration-tests.result }}" == "skipped" ]; then
          echo "â„¹ï¸ Integration Tests: Skipped" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ Integration Tests: Failed" >> $GITHUB_STEP_SUMMARY
        fi

        if [ "${{ needs.redis-compatibility.result }}" == "success" ]; then
          echo "âœ… Redis Compatibility: Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ Redis Compatibility: Failed" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“Š **Test Configuration:**" >> $GITHUB_STEP_SUMMARY
        echo "- PHP Versions: 8.1, 8.2, 8.3" >> $GITHUB_STEP_SUMMARY
        echo "- Dependencies: stable, lowest" >> $GITHUB_STEP_SUMMARY
        echo "- Redis Versions: 6.x, 7.x" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "For detailed test results, check the individual job logs and artifacts." >> $GITHUB_STEP_SUMMARY

  test-reporting:
    name: Test Reporting
    runs-on: ubuntu-latest
    if: always() && github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [unit-tests, integration-tests, performance-tests, redis-compatibility]

    steps:
    - name: Download test artifacts
      uses: actions/download-artifact@v3
      with:
        path: test-results

    - name: Generate test report
      run: |
        echo "# ðŸ§ª Test Report for Main Branch" > test-report.md
        echo "" >> test-report.md
        echo "Generated on: $(date)" >> test-report.md
        echo "" >> test-report.md

        echo "## ðŸ“Š Test Results Summary" >> test-report.md
        echo "" >> test-report.md

        # Count test files
        total_tests=0
        for file in test-results/*/*.xml; do
          if [ -f "$file" ]; then
            tests_in_file=$(grep -c 'testcase' "$file" 2>/dev/null || echo 0)
            total_tests=$((total_tests + tests_in_file))
          fi
        done

        echo "- **Total Test Cases**: $total_tests" >> test-report.md
        echo "- **PHP Versions Tested**: 8.1, 8.2, 8.3" >> test-report.md
        echo "- **Dependency Variants**: stable, lowest" >> test-report.md
        echo "- **Redis Versions**: 6.x, 7.x" >> test-report.md
        echo "" >> test-report.md

        # Add status badges
        if [ "${{ needs.unit-tests.result }}" == "success" ]; then
          echo "- **Unit Tests**: âœ… Passed" >> test-report.md
        else
          echo "- **Unit Tests**: âŒ Failed" >> test-report.md
        fi

        if [ "${{ needs.integration-tests.result }}" == "success" ]; then
          echo "- **Integration Tests**: âœ… Passed" >> test-report.md
        else
          echo "- **Integration Tests**: âŒ Failed" >> test-report.md
        fi

        if [ "${{ needs.performance-tests.result }}" == "success" ]; then
          echo "- **Performance Tests**: âœ… Passed" >> test-report.md
        else
          echo "- **Performance Tests**: âŒ Failed" >> test-report.md
        fi

        if [ "${{ needs.redis-compatibility.result }}" == "success" ]; then
          echo "- **Redis Compatibility**: âœ… Passed" >> test-report.md
        else
          echo "- **Redis Compatibility**: âŒ Failed" >> test-report.md
        fi

        echo "" >> test-report.md
        echo "## ðŸ”— Links" >> test-report.md
        echo "- [View detailed test results](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> test-report.md
        echo "- [Coverage Report](https://codecov.io/gh/${{ github.repository }})" >> test-report.md

    - name: Upload test report
      uses: actions/upload-artifact@v3
      with:
        name: test-report
        path: test-report.md
        retention-days: 90

    - name: Comment on commit
      if: github.event_name == 'push'
      run: |
        echo "Test report generated for commit ${{ github.sha }}" >> test-report.md
        echo "View the full test report at: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> test-report.md