name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'Is this a prerelease?'
        required: false
        type: boolean
        default: false

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.4'
        extensions: json, mbstring, tokenizer

    - name: Get version
      id: version
      run: |
        if [[ "${{ github.event_name }}" == "push" ]]; then
          VERSION=${GITHUB_REF#refs/tags/v}
        else
          VERSION="${{ github.event.inputs.version }}"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "version_number=$VERSION" >> $GITHUB_STEP_SUMMARY

    - name: Validate version format
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+)?$ ]]; then
          echo "âŒ Invalid version format. Expected: X.Y.Z or X.Y.Z-prerelease"
          exit 1
        fi
        echo "âœ… Version format validated: $VERSION"

    - name: Install dependencies
      run: composer install --prefer-dist --no-interaction

    - name: Run tests
      run: composer test

    - name: Run code style check
      run: composer cs-fix --dry-run --diff

    - name: Run static analysis
      run: composer analyse src

    - name: Generate changelog
      id: changelog
      run: |
        VERSION="${{ steps.version.outputs.version }}"

        # Get previous tag
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

        if [ -n "$PREVIOUS_TAG" ]; then
          echo "ðŸ“ Generating changelog since $PREVIOUS_TAG..."

          CHANGELOG=$(git log --pretty=format:"- %s (%h)" $PREVIOUS_TAG..HEAD --no-merges)
          echo "## Changes since $PREVIOUS_TAG" > changelog.md
          echo "" >> changelog.md
          echo "$CHANGELOG" >> changelog.md
        else
          echo "ðŸ“ Generating initial changelog..."
          echo "# Initial Release" > changelog.md
          echo "" >> changelog.md
          git log --pretty=format:"- %s (%h)" --no-merges >> changelog.md
        fi

        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        cat changelog.md >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Create Release Notes
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        echo "# Release $VERSION" > release-notes.md
        echo "" >> release-notes.md

        # Add package information
        echo "## Package Information" >> release-notes.md
        echo "" >> release-notes.md
        echo "- **Package**: friendsofhyperf/mcp" >> release-notes.md
        echo "- **Version**: $VERSION" >> release-notes.md
        echo "- **PHP Version**: ^8.1" >> release-notes.md
        echo "- **Hyperf Version**: ~3.1.0" >> release-notes.md
        echo "" >> release-notes.md

        # Add installation instructions
        echo "## Installation" >> release-notes.md
        echo "" >> release-notes.md
        echo '```bash' >> release-notes.md
        echo "composer require friendsofhyperf/mcp:^$VERSION" >> release-notes.md
        echo '```' >> release-notes.md
        echo "" >> release-notes.md

        # Add changelog
        echo "## Changelog" >> release-notes.md
        echo "" >> release-notes.md
        cat changelog.md >> release-notes.md

    - name: Create Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ steps.version.outputs.version }}
        release_name: Release ${{ steps.version.outputs.version }}
        body_path: release-notes.md
        draft: false
        prerelease: ${{ github.event.inputs.prerelease || false }}

    - name: Build package artifacts
      run: |
        VERSION="${{ steps.version.outputs.version }}"

        # Create source archive
        git archive --format=zip --prefix=mcp-${{ steps.version.outputs.version }}/ HEAD > mcp-${{ steps.version.outputs.version }}.zip

        # Create source tarball
        git archive --format=tar.gz --prefix=mcp-${{ steps.version.outputs.version }}/ HEAD > mcp-${{ steps.version.outputs.version }}.tar.gz

    - name: Upload release artifacts
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create-release.outputs.upload_url }}
        asset_path: mcp-${{ steps.version.outputs.version }}.zip
        asset_name: mcp-${{ steps.version.outputs.version }}.zip
        asset_content_type: application/zip

    - name: Upload release artifacts (tarball)
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create-release.outputs.upload_url }}
        asset_path: mcp-${{ steps.version.outputs.version }}.tar.gz
        asset_name: mcp-${{ steps.version.outputs.version }}.tar.gz
        asset_content_type: application/gzip

    - name: Update version in composer.json (if main branch)
      if: github.ref == 'refs/heads/main'
      run: |
        VERSION="${{ steps.version.outputs.version }}"

        # Update version in composer.json
        composer config version $VERSION

        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add composer.json
        git commit -m "chore: update version to $VERSION"
        git push origin main

    - name: Post to Slack (optional)
      if: secrets.SLACK_WEBHOOK_URL != ''
      run: |
        VERSION="${{ steps.version.outputs.version }}"

        curl -X POST -H 'Content-type: application/json' \
          --data "{\"text\":\"ðŸš€ New release: friendsofhyperf/mcp v$VERSION is now available!\"}" \
          ${{ secrets.SLACK_WEBHOOK_URL }}

    - name: Create summary
      run: |
        echo "# ðŸš€ Release Created Successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“¦ Release Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Version**: v${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Tag**: [v${{ steps.version.outputs.version }}](${{ github.server_url }}/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.version }})" >> $GITHUB_STEP_SUMMARY
        echo "- **Release**: [View Release](${{ github.server_url }}/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.version }})" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“¥ Installation" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "composer require friendsofhyperf/mcp:^${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“‹ Changelog" >> $GITHUB_STEP_SUMMARY
        echo "${{ steps.changelog.outputs.changelog }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… All tests passed before release!" >> $GITHUB_STEP_SUMMARY

  publish-to-packagist:
    name: Publish to Packagist
    runs-on: ubuntu-latest
    needs: create-release
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    environment: production

    steps:
    - name: Trigger Packagist update
      uses: joseph-schnarr/packagist-update-action@master
      with:
        username: ${{ secrets.PACKAGIST_USERNAME }}
        api_token: ${{ secrets.PACKAGIST_API_TOKEN }}
        package: friendsofhyperf/mcp

  notify-team:
    name: Notify Development Team
    runs-on: ubuntu-latest
    needs: [create-release, publish-to-packagist]
    if: always()

    steps:
    - name: Create notification
      run: |
        echo "Release process completed with status: ${{ job.status }}" > notification.md

        if [ "${{ needs.create-release.result }}" == "success" ] && [ "${{ needs.publish-to-packagist.result }}" == "success" ]; then
          echo "âœ… Successfully released friendsofhyperf/mcp v${{ github.ref_name }}" >> notification.md
          echo "ðŸ“¦ Available on Packagist: https://packagist.org/packages/friendsofhyperf/mcp" >> notification.md
        else
          echo "âŒ Release process encountered issues" >> notification.md
        fi

    - name: Upload notification
      uses: actions/upload-artifact@v3
      with:
        name: release-notification
        path: notification.md
        retention-days: 30