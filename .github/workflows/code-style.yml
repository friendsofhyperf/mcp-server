name: Code Style

on:
  push:
  pull_request:
    branches: [ main ]

jobs:
  code-style:
    name: Code Style Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.4'
        extensions: redis, json, mbstring, tokenizer

    - name: Get composer cache directory
      id: composer-cache
      run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

    - name: Cache composer dependencies
      uses: actions/cache@v3
      with:
        path: ${{ steps.composer-cache.outputs.dir }}
        key: ${{ runner.os }}-composer-code-style-${{ hashFiles('**/composer.json') }}
        restore-keys: |
          ${{ runner.os }}-composer-code-style-

    - name: Install dependencies
      run: composer install --prefer-dist --no-interaction

    - name: Run PHP CS Fixer (dry-run)
      run: composer cs-fix --dry-run --diff --verbose

    - name: Check if PHP CS Fixer would make changes
      run: |
        if ! composer cs-fix --dry-run --diff | grep -q "No files need to be fixed"; then
          echo "❌ Code style issues found. Please run 'composer cs-fix' to fix them."
          exit 1
        else
          echo "✅ Code style is correct!"
        fi

    - name: Check file permissions
      run: |
        echo "Checking file permissions..."
        find . -type f -name "*.php" -not -path "./vendor/*" -exec chmod 644 {} \;
        find . -type d -not -path "./vendor/*" -exec chmod 755 {} \;

  php-syntax:
    name: PHP Syntax Check
    runs-on: ubuntu-latest
    strategy:
      matrix:
        php-version: ['8.1', '8.2', '8.3', '8.4']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ matrix.php-version }}

    - name: Check PHP syntax
      run: |
        echo "Checking PHP syntax for PHP ${{ matrix.php-version }}..."
        find . -name "*.php" -not -path "./vendor/*" -not -path "./tests/*" -exec php -l {} \;
        if [ $? -ne 0 ]; then
          echo "❌ PHP syntax errors found"
          exit 1
        else
          echo "✅ All PHP files have correct syntax"
        fi

  json-yaml-validation:
    name: Config Validation
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Validate JSON files
      run: |
        echo "Validating JSON files..."
        find . -name "*.json" -not -path "./vendor/*" -exec python3 -m json.tool {} \; > /dev/null
        if [ $? -eq 0 ]; then
          echo "✅ All JSON files are valid"
        else
          echo "❌ Invalid JSON files found"
          exit 1
        fi

    - name: Validate YAML files
      run: |
        echo "Validating YAML files..."
        if command -v yamllint &> /dev/null; then
          find . -name "*.yml" -o -name "*.yaml" -not -path "./vendor/*" -exec yamllint {} \;
        else
          echo "⚠️ yamllint not found, skipping YAML validation"
        fi