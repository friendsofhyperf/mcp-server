name: Security

on:
  push:
  pull_request:
    branches: [ main ]
  schedule:
    # Run security scan daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  composer-audit:
    name: Composer Security Audit
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.4'
        extensions: redis, json, mbstring, tokenizer

    - name: Install dependencies
      run: composer install --prefer-dist --no-interaction --no-progress

    - name: Run composer audit
      run: composer audit

    - name: Check for known vulnerabilities
      run: |
        echo "ðŸ” Checking for known security vulnerabilities..."
        if composer audit --format=json | jq -e '.advisories | length > 0' > /dev/null; then
          echo "âš ï¸ Security advisories found:"
          composer audit --format=json | jq '.advisories[] | {name: .packageName, version: .affectedVersions, cve: .cve, severity: .severity}'
          echo "Please review and update dependencies as soon as possible."
        else
          echo "âœ… No security advisories found"
        fi

  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.4'

    - name: Install dependencies
      run: composer install --prefer-dist --no-interaction --no-progress

    - name: Run Enlightn Security Scanner
      run: |
        echo "ðŸ” Running Enlightn Security Scanner..."
        if ! composer show enlightn/security-checker >/dev/null 2>&1; then
          composer require --dev enlightn/security-checker
        fi

        ./vendor/bin/security-checker security:check composer.lock --format=json

        # Check if security issues exist
        if [ $? -eq 0 ]; then
          echo "âœ… No security vulnerabilities detected"
        else
          echo "âŒ Security vulnerabilities found!"
          ./vendor/bin/security-checker security:check composer.lock
          exit 1
        fi

    - name: Run Roave Security Advisories (if available)
      run: |
        echo "ðŸ” Running Roave Security Advisories check..."
        if ! composer show roave/security-advisories >/dev/null 2>&1; then
          echo "Installing Roave Security Advisories..."
          composer require --dev roave/security-advisories
        fi

        echo "Checking for security issues in dependencies..."
        composer why-not roave/security-advisories

        # Try to run the security check
        if composer show roave/security-advisories:dev-master 2>/dev/null; then
          echo "Roave Security Advisories check completed"
        else
          echo "Roave Security Advisories analysis completed"
        fi

  codeql:
    name: CodeQL Security Analysis
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: [ 'javascript' ]  # CodeQL supports JavaScript, which can analyze package.json

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v2
      with:
        languages: ${{ matrix.language }}

    - name: Autobuild
      uses: github/codeql-action/autobuild@v2

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v2
      with:
        category: "/language:${{matrix.language}}"

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Dependency Review
      uses: actions/dependency-review-action@v3
      with:
        # Additional options for dependency review
        fail-on-severity: moderate
        fail-on-scopes: runtime,development
        allow-ghsas: |
          GHSA-xxxx-xxxx-xxxx
        deny-licenses: |
          GPL-2.0
          GPL-3.0

  secrets-scan:
    name: Secrets Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history for better scanning

    - name: Run TruffleHog OSS
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD
        extra_args: --debug --only-verified

    - name: Run gitleaks
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

  php-security-check:
    name: PHP Security Best Practices
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.4'

    - name: Install dependencies
      run: composer install --prefer-dist --no-interaction --no-progress

    - name: Check for insecure PHP functions
      run: |
        echo "ðŸ” Checking for potentially insecure PHP functions..."

        # Check for dangerous functions
        dangerous_functions=("eval" "exec" "system" "shell_exec" "passthru" "popen" "proc_open")

        for func in "${dangerous_functions[@]}"; do
          if grep -r "\b$func\s*(" src/ --include="*.php" --exclude-dir=vendor 2>/dev/null; then
            echo "âš ï¸ Found potentially insecure function: $func"
            echo "Please review usage of $func and ensure proper sanitization"
          fi
        done

    - name: Check for hardcoded credentials
      run: |
        echo "ðŸ” Checking for hardcoded credentials..."

        # Common patterns for credentials
        patterns=(
          "password\s*=\s*['\"][^'\"]+['\"]"
          "secret\s*=\s*['\"][^'\"]+['\"]"
          "key\s*=\s*['\"][^'\"]+['\"]"
          "token\s*=\s*['\"][^'\"]+['\"]"
        )

        for pattern in "${patterns[@]}"; do
          if grep -r -i -E "$pattern" src/ --include="*.php" --exclude-dir=vendor 2>/dev/null; then
            echo "âš ï¸ Potential hardcoded credential pattern found"
            echo "Please ensure all credentials are stored securely in environment variables"
          fi
        done

    - name: Check file permissions and access
      run: |
        echo "ðŸ” Checking file access patterns..."

        # Check for file operations that might be vulnerable
        if grep -r "\bfile_get_contents\b" src/ --include="*.php" --exclude-dir=vendor 2>/dev/null; then
          echo "â„¹ï¸ Found file_get_contents usage - ensure proper validation of file paths"
        fi

        if grep -r "\bfopen\b" src/ --include="*.php" --exclude-dir=vendor 2>/dev/null; then
          echo "â„¹ï¸ Found fopen usage - ensure proper validation of file paths and modes"
        fi

        if grep -r "\bfile_put_contents\b" src/ --include="*.php" --exclude-dir=vendor 2>/dev/null; then
          echo "â„¹ï¸ Found file_put_contents usage - ensure proper validation of file paths"
        fi

  security-report:
    name: Security Report
    runs-on: ubuntu-latest
    if: always() && github.event_name == 'pull_request'
    needs: [composer-audit, security-scan, secrets-scan, php-security-check]

    steps:
    - name: Create security summary
      run: |
        echo "# Security Scan Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ needs.composer-audit.result }}" == "success" ]; then
          echo "âœ… Composer Security Audit: Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ Composer Security Audit: Failed" >> $GITHUB_STEP_SUMMARY
        fi

        if [ "${{ needs.security-scan.result }}" == "success" ]; then
          echo "âœ… Security Vulnerability Scan: Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ Security Vulnerability Scan: Failed" >> $GITHUB_STEP_SUMMARY
        fi

        if [ "${{ needs.secrets-scan.result }}" == "success" ]; then
          echo "âœ… Secrets Scan: Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ Secrets Scan: Failed" >> $GITHUB_STEP_SUMMARY
        fi

        if [ "${{ needs.php-security-check.result }}" == "success" ]; then
          echo "âœ… PHP Security Check: Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ PHP Security Check: Failed" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "For detailed security reports, check the individual job logs." >> $GITHUB_STEP_SUMMARY