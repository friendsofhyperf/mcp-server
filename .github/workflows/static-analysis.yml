name: Static Analysis

on:
  push:
  pull_request:
    branches: [ main ]

jobs:
  phpstan:
    name: PHPStan Static Analysis
    runs-on: ubuntu-latest
    strategy:
      matrix:
        php-version: ['8.1', '8.2', '8.3', '8.4']
        level: [1, 5, 8]
        include:
          - php-version: '8.4'
            level: 9
          - php-version: '8.4'
            level: max

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ matrix.php-version }}
        extensions: redis, json, mbstring, tokenizer, intl
        coverage: none

    - name: Get composer cache directory
      id: composer-cache
      run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

    - name: Cache composer dependencies
      uses: actions/cache@v3
      with:
        path: ${{ steps.composer-cache.outputs.dir }}
        key: ${{ runner.os }}-composer-phpstan-${{ matrix.php-version }}-${{ hashFiles('**/composer.json') }}
        restore-keys: |
          ${{ runner.os }}-composer-phpstan-${{ matrix.php-version }}-
          ${{ runner.os }}-composer-phpstan-

    - name: Install dependencies
      run: composer install --prefer-dist --no-interaction --no-progress

    - name: Validate PHPStan configuration
      run: |
        if [ -f "phpstan.neon.dist" ] || [ -f "phpstan.neon" ]; then
          echo "âœ… PHPStan configuration found"
          phpstan --version
        else
          echo "âŒ No PHPStan configuration found"
          exit 1
        fi

    - name: Run PHPStan (baseline check)
      if: matrix.level == 1
      run: composer analyse src --level=${{ matrix.level }} --memory-limit=1G --no-progress

    - name: Run PHPStan (standard levels)
      if: matrix.level != 1
      run: composer analyse src --level=${{ matrix.level }} --memory-limit=1G --no-progress

    - name: Check for baseline drift
      if: matrix.php-version == '8.4' && matrix.level == 8
      run: |
        if [ -f "phpstan-baseline.neon" ]; then
          echo "ðŸ” Checking for PHPStan baseline drift..."
          phpstan analyse src --level=8 --memory-limit=1G --no-progress --allow-baseline-update
          if git diff --quiet phpstan-baseline.neon; then
            echo "âœ… No baseline drift detected"
          else
            echo "âš ï¸ Baseline has changed. Consider running 'phpstan analyse --generate-baseline' to update."
            git diff phpstan-baseline.neon
          fi
        fi

  phpstan-pro:
    name: PHPStan Pro Analysis
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.4'
        extensions: redis, json, mbstring, tokenizer, intl
        coverage: none

    - name: Install dependencies
      run: composer install --prefer-dist --no-interaction --no-progress

    - name: Run PHPStan Pro (if configured)
      run: |
        if [ -f ".phpstan-pro.php" ] || grep -q "proVersion" phpstan.neon* 2>/dev/null; then
          echo "ðŸš€ Running PHPStan Pro analysis..."
          phpstan analyse src --memory-limit=2G --no-progress --debug
        else
          echo "â„¹ï¸ PHPStan Pro not configured, skipping Pro analysis"
        fi
      env:
        PHPSTAN_PRO_LICENSE_KEY: ${{ secrets.PHPSTAN_PRO_LICENSE_KEY }}

  Psalm:
    name: Psalm Static Analysis
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.4'
        extensions: redis, json, mbstring, tokenizer, intl
        coverage: none

    - name: Install dependencies
      run: composer install --prefer-dist --no-interaction --no-progress

    - name: Check for Psalm configuration
      run: |
        if [ -f "psalm.xml" ] || [ -f "psalm.xml.dist" ]; then
          echo "âœ… Psalm configuration found"
          composer require --dev vimeo/psalm --no-update
          composer update vimeo/psalm --no-interaction --no-progress

          echo "ðŸ” Running Psalm analysis..."
          ./vendor/bin/psalm --show-info=false
        else
          echo "â„¹ï¸ No Psalm configuration found, skipping Psalm analysis"
        fi

  metrics:
    name: Code Metrics
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.4'

    - name: Install dependencies
      run: composer install --prefer-dist --no-interaction --no-progress

    - name: Run code metrics
      run: |
        echo "ðŸ“Š Calculating code metrics..."

        # Count lines of code
        echo "Lines of code:"
        find src -name "*.php" -not -path "*/vendor/*" | xargs wc -l | tail -1

        # Count number of classes
        echo "Number of classes:"
        find src -name "*.php" -not -path "*/vendor/*" | xargs grep -l "^class " | wc -l

        # Count number of methods
        echo "Number of methods:"
        find src -name "*.php" -not -path "*/vendor/*" | xargs grep -E "^\s*(public|private|protected)\s+function" | wc -l

        # Check cyclomatic complexity (if PHPMD is available)
        if composer show phpmd/phpmd >/dev/null 2>&1; then
          echo "Running PHPMD analysis..."
          ./vendor/bin/phpmd src xml cleancode,codesize,controversial,design,naming,unusedcode --reportfile phpmd-report.xml || true

          if [ -f "phpmd-report.xml" ]; then
            echo "PHPMD report generated"
            cat phpmd-report.xml
          fi
        else
          echo "PHPMD not available, skipping complexity analysis"
        fi